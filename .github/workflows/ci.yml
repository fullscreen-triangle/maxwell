# =============================================================================
# Maxwell Project - CI/CD Pipeline
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ---------------------------------------------------------------------------
  # Rust Checks
  # ---------------------------------------------------------------------------
  rust-check:
    name: Rust Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          components: clippy, rustfmt
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
      
      - name: Build
        run: cargo build --workspace --release
      
      - name: Test
        run: cargo test --workspace

  # ---------------------------------------------------------------------------
  # Python Validation
  # ---------------------------------------------------------------------------
  python-validation:
    name: Python Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          cd validation
          pip install -e ".[dev]"
      
      - name: Run validation
        run: |
          cd validation
          python -m maxwell_validation.dissolution
      
      - name: Run pytest
        run: |
          cd validation
          pytest -v || true  # Don't fail if no tests yet

  # ---------------------------------------------------------------------------
  # Documentation
  # ---------------------------------------------------------------------------
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      
      - name: Build docs
        run: cargo doc --workspace --no-deps
      
      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: target/doc

  # ---------------------------------------------------------------------------
  # Security Audit
  # ---------------------------------------------------------------------------
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cargo-audit
        run: cargo install cargo-audit
      
      - name: Run audit
        run: cargo audit || true  # Advisory only

  # ---------------------------------------------------------------------------
  # Docker Build
  # ---------------------------------------------------------------------------
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -t maxwell-processor:${{ github.sha }} .
      
      - name: Test Docker image
        run: docker run --rm maxwell-processor:${{ github.sha }} dissolution

  # ---------------------------------------------------------------------------
  # Release
  # ---------------------------------------------------------------------------
  release:
    name: Release
    needs: [rust-check, python-validation, docker]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
      
      - name: Build release
        run: cargo build --workspace --release
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: maxwell-linux-x64
          path: target/release/maxwell

